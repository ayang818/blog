---
title: 通过js解析获取B站弹幕发送者
date: 2019-07-20 17:14:45
tags: [自嗨,python,随笔]
---
# 代码地址
[B站弹幕下载,查找发送者工具](https://github.com/ayang818/Useful-Crawl/blob/master/bilibiliDanmakuCrawl.py)
需要python环境才能使用。

# Why？
- 感觉暑假刷B站刷的比较多，有时候看到一些嘴臭的弹幕就想把那些人从屏幕后面揪出来嘴臭回去，然后就想这可不可以通过弹幕找到发送者。

- 手机流量限速到1M，刷B站的时候卡的要死，心里想着把弹幕关了会不会加载的快一点(一开始没仔细想，以为B站的的弹幕是轮询的，然后认为既然是每隔一段时间请求一次，关闭弹幕应该会终止轮询行为)，但是后来抓包的时候发现，显然不会加载的快一点啊QAQ！！！
<br>
<!-- more -->

# How？

## 抓包
一开始懒得去查B站的弹幕应该怎么获取，然后自己寻思着弹幕估计也是从一个接口里获取的，然后就开始自己抓包。
显然请求弹幕接口是在XHR(XMLHttpRequest)中, 然后其实很容易就能找到这个Api

![](getpack.png)
<br>就是这个请求，然后其中的接口中<br>
![](request.png)
<br>就包含了弹幕的所有信息，是一个XML文件
![](xml.png)
为了确认这里的弹幕是否齐全，我对照了d标签的数量和B站视频实时显示的弹幕数是否相同<br>
![](danmukuNum.png)
<br>最后确认没有数据遗漏。

## 查找用户
确认数据没有被投毒或者缺失以后，就是开始根据弹幕查找用户了，我很确认得到的数据中肯定是有用户信息的，并且就是接口的XML的d标签的p属性中的某一个。因为我们知道B站是有屏蔽某个用户弹幕的功能的，那么肯定需要一个唯一标识符，那么肯定是用户ID。然后我就开始手动屏蔽弹幕(对着某条弹幕右键就可以了)。然后惊喜的发现
![](fliter.png)
![](flitername.png)
<br>这么容易就找到了，也就是说d标签的p属性的第七个属性应该就是ID之类的东西。
然后我兴高采烈的复制的这串ID，结果。。。
![](noneResponse.png)
搜不到嗷！那么显然这个就是加密后的ID了。然后我就开始试了试比较常用的hash加密方法，没有试出来，然后去Google一下，是一种我没有用过的hash算法，叫ITU I.363.5 算法，然后还找到了个Api，
```
(http://biliquery.typcn.com/api/user/hash/[用户Hash]
```
最后就美滋滋的找到了Hash前的的用户ID。<br>

在B站的搜索栏中搜索 UID:用户ID 即可搜索到该用户
## 兼容性
为了兼容每一个视频，并且考虑到一些用户不知道怎么抓包，我又分析了一下怎么根据每个视频的av号找到弹幕接口，首先分析每个视频的弹幕接口
```
https://api.bilibili.com/x/v1/dm/list.so?oid=62627218
```
我发现每条请求的都有一个param叫做oid，那我想这个应该就是每个视频唯一表示符，但是这个视频的av号又不相同。所以我就开始再网页没有渲染过的源代码里找oid，先把这个一个确定的oid在源代码里查找<br>
![](cid.png)
<br>
发现这个叫做cid，emmmm...，这个是什么鬼，对比多个视频源代码，发现第一个cid对应的数字就是我们需要的oid，所以这里选择使用正则暴力筛选出来oid。
这样我们就完成了一次查询流程<br>
假设
```
用户输入av号 > 根据av号找到视频网址 > 使用正则解析出oid > 携带oid去请求弹幕接口 > 解析弹幕接口返回的出来的弹幕中hashed的用户ID > 携带hashed的用户ID去请求rehash接口得到弹幕发送者的真实ID > 将弹幕内容及弹幕发送者写入文件
```
这样子就大功告成了！